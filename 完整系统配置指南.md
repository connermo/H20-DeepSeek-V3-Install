# H20 8å¡æœåŠ¡å™¨å®Œæ•´é…ç½®æŒ‡å—
## ä»æ“ä½œç³»ç»Ÿåˆ°vLLMæ¨ç†å¼•æ“çš„å®Œæ•´éƒ¨ç½²

---

## ç›®å½•

1. [ç¡¬ä»¶å‡†å¤‡ä¸æ£€æŸ¥](#ç¡¬ä»¶å‡†å¤‡ä¸æ£€æŸ¥)
2. [Ubuntu 22.04 LTS å®‰è£…](#ubuntu-2204-lts-å®‰è£…)
3. [ç³»ç»ŸåŸºç¡€é…ç½®](#ç³»ç»ŸåŸºç¡€é…ç½®)
4. [å¤šæ ¸CPUä¼˜åŒ–é…ç½®](#å¤šæ ¸cpuä¼˜åŒ–é…ç½®)
5. [NVIDIAé©±åŠ¨å®‰è£…](#nvidiaé©±åŠ¨å®‰è£…)
6. [CUDA Toolkitå®‰è£…](#cuda-toolkitå®‰è£…)
7. [NVLinké…ç½®ä¸æ£€æµ‹](#nvlinké…ç½®ä¸æ£€æµ‹)
8. [ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–](#ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–)
9. [vLLMç¯å¢ƒéƒ¨ç½²](#vllmç¯å¢ƒéƒ¨ç½²)
10. [å®Œæ•´æ€§éªŒè¯](#å®Œæ•´æ€§éªŒè¯)

---

## ç¡¬ä»¶å‡†å¤‡ä¸æ£€æŸ¥

### æ¨èç¡¬ä»¶é…ç½®

```
æœåŠ¡å™¨é…ç½®æ¸…å•:
â”œâ”€â”€ CPU: Intel Xeonæˆ–AMD EPYC (32æ ¸å¿ƒä»¥ä¸Šæ¨è)
â”œâ”€â”€ å†…å­˜: 512GB DDR4/DDR5 ECC (768GBæ¨è)
â”œâ”€â”€ GPU: NVIDIA H20 x 8å¼ 
â”‚   â”œâ”€â”€ æ¯å¡æ˜¾å­˜: 141GB
â”‚   â”œâ”€â”€ æ€»æ˜¾å­˜: ~1128GB
â”‚   â””â”€â”€ äº’è”: NVLink/NVSwitch
â”œâ”€â”€ å­˜å‚¨:
â”‚   â”œâ”€â”€ ç³»ç»Ÿç›˜: 500GB NVMe SSD
â”‚   â”œâ”€â”€ æ•°æ®ç›˜: 2TB+ NVMe SSD (RAIDé…ç½®æ¨è)
â”‚   â””â”€â”€ å¤‡ä»½ç›˜: 10TB+ HDD (å¯é€‰)
â””â”€â”€ ç½‘ç»œ: 10Gbps+ ä»¥å¤ªç½‘å¡
```

### ç¡¬ä»¶æ£€æŸ¥æ¸…å•

åœ¨å®‰è£…æ“ä½œç³»ç»Ÿå‰ï¼Œè¯·ç¡®è®¤ï¼š

```bash
# BIOSè®¾ç½®æ£€æŸ¥é¡¹
â–¡ å¯ç”¨UEFIæ¨¡å¼
â–¡ ç¦ç”¨Secure Boot (æˆ–é…ç½®MOK)
â–¡ å¯ç”¨VT-x/AMD-V (è™šæ‹ŸåŒ–æ”¯æŒ)
â–¡ å¯ç”¨IOMMU (ç”¨äºGPUç›´é€š)
â–¡ è®¾ç½®é£æ‰‡ç­–ç•¥ä¸ºæ€§èƒ½æ¨¡å¼
â–¡ å¯ç”¨æ‰€æœ‰PCIeæ’æ§½
â–¡ ç¡®è®¤NVLinkæ¡¥æ¥å¡å·²æ­£ç¡®å®‰è£…

# ç‰©ç†æ£€æŸ¥
â–¡ æ‰€æœ‰GPUå¡å·²æ­£ç¡®æ’å…¥PCIeæ’æ§½
â–¡ GPUä¾›ç”µçº¿å·²å…¨éƒ¨è¿æ¥
â–¡ NVLinkæ¡¥æ¥çº¿å·²æ­£ç¡®è¿æ¥ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
â–¡ æ•£çƒ­ç³»ç»Ÿæ­£å¸¸å·¥ä½œ
â–¡ ç½‘ç»œçº¿å·²è¿æ¥
```

---

## Ubuntu 22.04 LTS å®‰è£…

### 1. ä¸‹è½½Ubuntu 22.04 LTS Server

```bash
# ä¸‹è½½åœ°å€
https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso

# éªŒè¯SHA256 (å¯é€‰ä½†æ¨è)
sha256sum ubuntu-22.04.3-live-server-amd64.iso
```

### 2. åˆ¶ä½œå¯åŠ¨Uç›˜

**åœ¨Linux/macOSä¸Š:**

```bash
# æŸ¥çœ‹Uç›˜è®¾å¤‡å (å‡è®¾ä¸º/dev/sdb)
lsblk

# å†™å…¥ISO (æ³¨æ„æ›¿æ¢è®¾å¤‡å)
sudo dd if=ubuntu-22.04.3-live-server-amd64.iso of=/dev/sdb bs=4M status=progress && sync
```

**åœ¨Windowsä¸Š:**
- ä½¿ç”¨ Rufus æˆ– balenaEtcher å·¥å…·

### 3. å®‰è£…Ubuntu 22.04

**å®‰è£…æ­¥éª¤:**

1. **å¯åŠ¨åˆ°å®‰è£…ç¨‹åº**
   - ä»Uç›˜å¯åŠ¨
   - é€‰æ‹© "Install Ubuntu Server"

2. **è¯­è¨€å’Œé”®ç›˜**
   - è¯­è¨€: English (æ¨èï¼Œé¿å…ç¼–ç é—®é¢˜)
   - é”®ç›˜: é€‰æ‹©å®é™…é”®ç›˜å¸ƒå±€

3. **ç½‘ç»œé…ç½®**
   ```
   - ä½¿ç”¨DHCPæˆ–é…ç½®é™æ€IP
   - æ¨èé™æ€IPé…ç½®ç¤ºä¾‹:
     IP: 192.168.1.100/24
     Gateway: 192.168.1.1
     DNS: 8.8.8.8, 8.8.4.4
   ```

4. **å­˜å‚¨é…ç½®**

   **æ–¹æ¡ˆä¸€: ç®€å•é…ç½® (å•ç³»ç»Ÿç›˜)**
   ```
   ä½¿ç”¨æ•´ä¸ªç£ç›˜ï¼ŒLVMé…ç½®:
   /boot/efi    1GB     (EFIåˆ†åŒº)
   /boot        2GB     (å¯åŠ¨åˆ†åŒº)
   /            100GB   (æ ¹åˆ†åŒº)
   /home        100GB   (ç”¨æˆ·ç›®å½•)
   /var         100GB   (æ—¥å¿—å’Œç¼“å­˜)
   swap         64GB    (äº¤æ¢åˆ†åŒº)
   ```

   **æ–¹æ¡ˆäºŒ: é«˜çº§é…ç½® (å¤šç›˜RAID)**
   ```bash
   # ç³»ç»Ÿç›˜ (NVMe SSD 500GB)
   /dev/nvme0n1p1   1GB      EFI
   /dev/nvme0n1p2   2GB      /boot
   /dev/nvme0n1p3   200GB    / (LVM)
   /dev/nvme0n1p4   å‰©ä½™     /home (LVM)

   # æ•°æ®ç›˜ (2x 2TB NVMe SSD RAID 0)
   /dev/md0         4TB      /data (è½¯RAID 0)
   ```

5. **ç”¨æˆ·é…ç½®**
   ```
   ç”¨æˆ·å: admin (æˆ–è‡ªå®šä¹‰)
   æœåŠ¡å™¨å: h20-server-01
   å¯†ç : è®¾ç½®å¼ºå¯†ç 
   â˜‘ Install OpenSSH server (å¿…é€‰)
   ```

6. **è½¯ä»¶é€‰æ‹©**
   ```
   ä¸å‹¾é€‰ä»»ä½•é¢å¤–çš„è½¯ä»¶åŒ…
   (æˆ‘ä»¬ä¼šåœ¨åç»­æ‰‹åŠ¨å®‰è£…æ‰€éœ€è½¯ä»¶)
   ```

7. **å®Œæˆå®‰è£…**
   - ç­‰å¾…å®‰è£…å®Œæˆ
   - é‡å¯å¹¶ç§»é™¤Uç›˜

### 4. é¦–æ¬¡ç™»å½•

```bash
# SSHç™»å½• (ä»å¦ä¸€å°æœºå™¨)
ssh admin@192.168.1.100

# æˆ–ç›´æ¥åœ¨æœåŠ¡å™¨ç»ˆç«¯ç™»å½•
```

---

## ç³»ç»ŸåŸºç¡€é…ç½®

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
sudo apt update

# å‡çº§æ‰€æœ‰è½¯ä»¶åŒ…
sudo apt upgrade -y

# å®‰è£…å¿…è¦çš„åŸºç¡€å·¥å…·
sudo apt install -y \
    build-essential \
    vim \
    wget \
    curl \
    git \
    htop \
    tmux \
    net-tools \
    lsof \
    sysstat \
    linux-headers-$(uname -r)
```

### 2. é…ç½®é™æ€IP (å¦‚æœæœªåœ¨å®‰è£…æ—¶é…ç½®)

```bash
# ç¼–è¾‘netplané…ç½®
sudo vim /etc/netplan/00-installer-config.yaml
```

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens1f0:  # æ›¿æ¢ä¸ºå®é™…ç½‘å¡åç§°
      addresses:
        - 192.168.1.100/24
      routes:
        - to: default
          via: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
```

```bash
# åº”ç”¨é…ç½®
sudo netplan apply

# éªŒè¯ç½‘ç»œ
ip addr show
ping -c 4 8.8.8.8
```

### 3. é…ç½®SSH

```bash
# ç¼–è¾‘SSHé…ç½®
sudo vim /etc/ssh/sshd_config
```

```bash
# æ¨èçš„å®‰å…¨é…ç½®
Port 22
PermitRootLogin no
PubkeyAuthentication yes
PasswordAuthentication yes  # é…ç½®å¯†é’¥åå¯æ”¹ä¸ºno
MaxAuthTries 3
MaxSessions 10
```

```bash
# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd

# (å¯é€‰) é…ç½®SSHå¯†é’¥ç™»å½•
# åœ¨æœ¬åœ°æœºå™¨ç”Ÿæˆå¯†é’¥
ssh-keygen -t ed25519 -C "your_email@example.com"

# å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id admin@192.168.1.100
```

### 4. é…ç½®é˜²ç«å¢™

```bash
# å¯ç”¨UFWé˜²ç«å¢™
sudo ufw enable

# å…è®¸SSH
sudo ufw allow 22/tcp

# å…è®¸vLLM APIç«¯å£
sudo ufw allow 8000/tcp

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 5. é…ç½®æ—¶é—´åŒæ­¥

```bash
# å®‰è£…chrony
sudo apt install -y chrony

# é…ç½®æ—¶åŒº
sudo timedatectl set-timezone Asia/Shanghai

# å¯åŠ¨æ—¶é—´åŒæ­¥
sudo systemctl enable chrony
sudo systemctl start chrony

# éªŒè¯
timedatectl
```

---

## å¤šæ ¸CPUä¼˜åŒ–é…ç½®

### 1. æŸ¥çœ‹CPUä¿¡æ¯

```bash
# æŸ¥çœ‹CPUåŸºæœ¬ä¿¡æ¯
lscpu

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
cat /proc/cpuinfo

# æŸ¥çœ‹NUMAæ‹“æ‰‘
numactl --hardware

# é¢„æœŸè¾“å‡ºç¤ºä¾‹ (64æ ¸å¿ƒ):
# available: 2 nodes (0-1)
# node 0 cpus: 0-31
# node 1 cpus: 32-63
```

### 2. CPUæ€§èƒ½æ¨¡å¼é…ç½®

```bash
# å®‰è£…cpufrequtils
sudo apt install -y cpufrequtils

# æŸ¥çœ‹å½“å‰CPUè°ƒåº¦å™¨
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# è®¾ç½®ä¸ºæ€§èƒ½æ¨¡å¼
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# æ°¸ä¹…ç”Ÿæ•ˆ - åˆ›å»ºsystemdæœåŠ¡
sudo tee /etc/systemd/system/cpu-performance.service > /dev/null << 'EOF'
[Unit]
Description=CPU Performance Mode
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo performance | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable cpu-performance
sudo systemctl start cpu-performance
```

### 3. CPUäº²å’Œæ€§å’Œä¸­æ–­ä¼˜åŒ–

```bash
# å®‰è£…irqbalance (ä¼˜åŒ–ä¸­æ–­åˆ†é…)
sudo apt install -y irqbalance

# é…ç½®irqbalance
sudo vim /etc/default/irqbalance
```

```bash
# æ·»åŠ ä»¥ä¸‹é…ç½®
ENABLED="1"
ONESHOT="0"
# å¯é€‰: æ’é™¤æŸäº›CPUæ ¸å¿ƒï¼Œç•™ç»™ç‰¹å®šä»»åŠ¡
# IRQBALANCE_BANNED_CPUS="0xffffffff,0x00000000"  # ç¤ºä¾‹: æ’é™¤0-31æ ¸
```

```bash
# é‡å¯irqbalance
sudo systemctl restart irqbalance
sudo systemctl enable irqbalance
```

### 4. NUMAä¼˜åŒ–é…ç½®

```bash
# å®‰è£…numactl
sudo apt install -y numactl

# æŸ¥çœ‹NUMAèŠ‚ç‚¹ç»‘å®š
numactl --show

# åˆ›å»ºNUMAé…ç½®è„šæœ¬
cat > ~/numa_config.sh << 'EOF'
#!/bin/bash
# NUMAä¼˜åŒ–é…ç½®è„šæœ¬

# ç¦ç”¨é€æ˜å¤§é¡µ (Transparent Huge Pages)
echo never | sudo tee /sys/kernel/mm/transparent_hugepage/enabled
echo never | sudo tee /sys/kernel/mm/transparent_hugepage/defrag

# è®¾ç½®NUMAå¹³è¡¡ç­–ç•¥
echo 1 | sudo tee /proc/sys/kernel/numa_balancing

# è®¾ç½®zone_reclaim_mode (0=å…è®¸è·¨NUMAè®¿é—®, 1=æœ¬åœ°å›æ”¶)
echo 0 | sudo tee /proc/sys/vm/zone_reclaim_mode
EOF

chmod +x ~/numa_config.sh

# åˆ›å»ºsystemdæœåŠ¡ä½¿å…¶å¼€æœºç”Ÿæ•ˆ
sudo tee /etc/systemd/system/numa-config.service > /dev/null << 'EOF'
[Unit]
Description=NUMA Configuration
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/home/admin/numa_config.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable numa-config
sudo systemctl start numa-config
```

### 5. CPUéš”ç¦» (ç”¨äºä¸“ç”¨å·¥ä½œè´Ÿè½½)

å¦‚æœéœ€è¦å°†æŸäº›CPUæ ¸å¿ƒä¸“é—¨ç”¨äºæ·±åº¦å­¦ä¹ ä»»åŠ¡ï¼š

```bash
# ç¼–è¾‘GRUBé…ç½®
sudo vim /etc/default/grub

# ä¿®æ”¹GRUB_CMDLINE_LINUXï¼Œä¾‹å¦‚éš”ç¦»CPU 32-63:
GRUB_CMDLINE_LINUX="isolcpus=32-63 nohz_full=32-63 rcu_nocbs=32-63"

# æ›´æ–°GRUB
sudo update-grub

# é‡å¯ç³»ç»Ÿ
sudo reboot
```

### 6. éªŒè¯CPUé…ç½®

```bash
# åˆ›å»ºCPUæµ‹è¯•è„šæœ¬
cat > ~/test_cpu.sh << 'EOF'
#!/bin/bash
echo "=== CPUä¿¡æ¯ ==="
lscpu | grep -E "CPU\(s\)|Thread|Core|Socket|NUMA"

echo -e "\n=== CPUè°ƒåº¦å™¨ ==="
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

echo -e "\n=== NUMAé…ç½® ==="
numactl --hardware | head -10

echo -e "\n=== é€æ˜å¤§é¡µçŠ¶æ€ ==="
cat /sys/kernel/mm/transparent_hugepage/enabled

echo -e "\n=== CPUé¢‘ç‡ (å‰4ä¸ªæ ¸å¿ƒ) ==="
for i in {0..3}; do
    echo -n "CPU$i: "
    cat /sys/devices/system/cpu/cpu$i/cpufreq/scaling_cur_freq
done
EOF

chmod +x ~/test_cpu.sh
~/test_cpu.sh
```

---

## NVIDIAé©±åŠ¨å®‰è£…

### 1. æ£€æŸ¥GPUæ˜¯å¦è¢«è¯†åˆ«

```bash
# æ£€æŸ¥PCIeè®¾å¤‡
lspci | grep -i nvidia

# é¢„æœŸè¾“å‡º (8å¼ H20):
# 17:00.0 3D controller: NVIDIA Corporation ...
# 31:00.0 3D controller: NVIDIA Corporation ...
# ... (å…±8æ¡)
```

### 2. ç¦ç”¨nouveaué©±åŠ¨

```bash
# åˆ›å»ºé»‘åå•æ–‡ä»¶
sudo tee /etc/modprobe.d/blacklist-nouveau.conf > /dev/null << 'EOF'
blacklist nouveau
options nouveau modeset=0
EOF

# æ›´æ–°initramfs
sudo update-initramfs -u

# é‡å¯ç³»ç»Ÿ
sudo reboot
```

### 3. é‡å¯åéªŒè¯nouveauå·²ç¦ç”¨

```bash
# æ£€æŸ¥nouveauæ˜¯å¦å·²ç¦ç”¨ (åº”è¯¥æ— è¾“å‡º)
lsmod | grep nouveau
```

### 4. å®‰è£…NVIDIAé©±åŠ¨

**æ–¹æ³•ä¸€: ä½¿ç”¨Ubuntuä»“åº“ (æ¨èï¼Œç®€å•ç¨³å®š)**

```bash
# æ·»åŠ graphics-drivers PPA
sudo add-apt-repository ppa:graphics-drivers/ppa -y
sudo apt update

# æŸ¥çœ‹å¯ç”¨çš„é©±åŠ¨ç‰ˆæœ¬
ubuntu-drivers devices

# è‡ªåŠ¨å®‰è£…æ¨èé©±åŠ¨ (ä¼šå®‰è£…æœ€æ–°ç¨³å®šç‰ˆæœ¬)
sudo ubuntu-drivers autoinstall

# æˆ–æ‰‹åŠ¨å®‰è£…ç‰¹å®šç‰ˆæœ¬ (æ¨è550ç³»åˆ—ç”¨äºH20)
sudo apt install -y nvidia-driver-550

# é‡å¯ç³»ç»Ÿ
sudo reboot
```

**æ–¹æ³•äºŒ: ä½¿ç”¨NVIDIAå®˜æ–¹.runæ–‡ä»¶ (é«˜çº§ç”¨æˆ·)**

```bash
# ä¸‹è½½æœ€æ–°é©±åŠ¨ (è®¿é—® https://www.nvidia.com/Download/index.aspx)
# å¯¹äºH20æ•°æ®ä¸­å¿ƒGPUï¼Œæ¨èä½¿ç”¨550ç³»åˆ—æˆ–æ›´æ–°ç‰ˆæœ¬
wget https://us.download.nvidia.com/XFree86/Linux-x86_64/580.65.06/NVIDIA-Linux-x86_64-580.65.06.run

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x NVIDIA-Linux-x86_64-580.65.06.run

# åœæ­¢å›¾å½¢ç•Œé¢ (Serverç‰ˆæœ¬é€šå¸¸æ— éœ€æ­¤æ­¥)
sudo systemctl isolate multi-user.target

# å®‰è£…é©±åŠ¨
sudo ./NVIDIA-Linux-x86_64-580.65.06.run

# å®‰è£…é€‰é¡¹:
# - Accept license
# - Install NVIDIA's 32-bit compatibility libraries? YES
# - Would you like to run nvidia-xconfig? NO (Serverç‰ˆæœ¬)

# é‡å¯ç³»ç»Ÿ
sudo reboot
```

### 5. éªŒè¯é©±åŠ¨å®‰è£…

```bash
# æ£€æŸ¥nvidia-smi
nvidia-smi

# é¢„æœŸè¾“å‡ºç¤ºä¾‹:
# +-----------------------------------------------------------------------------+
# | NVIDIA-SMI 580.65.06   Driver Version: 580.65.06   CUDA Version: 13.0   |
# |-------------------------------+----------------------+----------------------+
# | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
# | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
# |===============================+======================+======================|
# |   0  NVIDIA H20          Off  | 00000000:17:00.0 Off |                    0 |
# | N/A   32C    P0    68W / 400W |      0MiB / 141824MiB|      0%      Default |
# ...
# (å…±8ä¸ªGPU)

# æ£€æŸ¥é©±åŠ¨ç‰ˆæœ¬
cat /proc/driver/nvidia/version

# æ£€æŸ¥GPUè¯¦ç»†ä¿¡æ¯
nvidia-smi -L
nvidia-smi -q
```

### 6. é…ç½®æŒä¹…åŒ–æ¨¡å¼

```bash
# å¯ç”¨æŒä¹…åŒ–æ¨¡å¼ (æé«˜æ€§èƒ½ï¼Œå‡å°‘åˆå§‹åŒ–å»¶è¿Ÿ)
sudo nvidia-smi -pm 1

# è®¾ç½®æ‰€æœ‰GPUçš„ç”µæºç®¡ç†æ¨¡å¼
sudo nvidia-smi -pl 400  # è®¾ç½®åŠŸè€—ä¸Šé™ä¸º400W (æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)

# åˆ›å»ºsystemdæœåŠ¡ä½¿å…¶å¼€æœºç”Ÿæ•ˆ
sudo tee /etc/systemd/system/nvidia-persistenced.service > /dev/null << 'EOF'
[Unit]
Description=NVIDIA Persistence Daemon
Wants=syslog.target

[Service]
Type=forking
ExecStart=/usr/bin/nvidia-persistenced --user nvidia-persistenced --persistence-mode
ExecStopPost=/bin/rm -rf /var/run/nvidia-persistenced

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable nvidia-persistenced
sudo systemctl start nvidia-persistenced
```

---

## CUDA Toolkitå®‰è£…

### 1. ä¸‹è½½CUDA Toolkit

è®¿é—® https://developer.nvidia.com/cuda-downloads æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ:

```bash
# æ·»åŠ NVIDIA CUDAä»“åº“ (Ubuntu 22.04)
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb
sudo apt update
```

### 2. å®‰è£…CUDA 13.0 (æ¨èç¨³å®šç‰ˆæœ¬)

```bash
# å®‰è£…CUDA Toolkit 13.0
sudo apt install -y cuda-toolkit-13-0

# æˆ–å®‰è£…å®Œæ•´CUDAåŒ… (åŒ…å«é©±åŠ¨)
# sudo apt install -y cuda

# å¦‚éœ€å®‰è£…å…¶ä»–ç‰ˆæœ¬ï¼Œå¯ç”¨ç‰ˆæœ¬åŒ…æ‹¬:
# cuda-toolkit-13-1  (CUDA 13.1 - æœ€æ–°ç‰ˆ)
# cuda-toolkit-12-9  (CUDA 12.9)
# cuda-toolkit-12-8  (CUDA 12.8)
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# ç¼–è¾‘.bashrc
vim ~/.bashrc

# æ·»åŠ ä»¥ä¸‹å†…å®¹åˆ°æ–‡ä»¶æœ«å°¾
export CUDA_HOME=/usr/local/cuda-13.0
export PATH=$CUDA_HOME/bin:$PATH
export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

# ä½¿é…ç½®ç”Ÿæ•ˆ
source ~/.bashrc
```

### 4. éªŒè¯CUDAå®‰è£…

```bash
# æ£€æŸ¥CUDAç‰ˆæœ¬
nvcc --version

# é¢„æœŸè¾“å‡º:
# nvcc: NVIDIA (R) Cuda compiler driver
# Copyright (c) 2005-2025 NVIDIA Corporation
# Cuda compilation tools, release 13.0, V13.0.x

# ç¼–è¯‘CUDAç¤ºä¾‹ (å¦‚æœsampleså·²å®‰è£…)
cd /usr/local/cuda-13.0/samples/1_Utilities/deviceQuery
sudo make

# è¿è¡Œæµ‹è¯•
./deviceQuery

# é¢„æœŸè¾“å‡ºåº”æ˜¾ç¤ºæ‰€æœ‰8å¼ GPUçš„è¯¦ç»†ä¿¡æ¯ï¼ŒResult = PASS
```

### 5. å®‰è£…cuDNN (å¯é€‰ï¼ŒæŸäº›æ¡†æ¶éœ€è¦)

```bash
# ä¸‹è½½cuDNN (éœ€è¦NVIDIAè´¦æˆ·)
# è®¿é—®: https://developer.nvidia.com/cudnn

# å®‰è£…cuDNN
# å‡è®¾ä¸‹è½½äº† cudnn-linux-x86_64-8.9.7.29_cuda12-archive.tar.xz

tar -xvf cudnn-linux-x86_64-8.9.7.29_cuda12-archive.tar.xz
cd cudnn-linux-x86_64-8.9.7.29_cuda12-archive

# å¤åˆ¶æ–‡ä»¶åˆ°CUDAç›®å½•
sudo cp include/cudnn*.h /usr/local/cuda-13.0/include/
sudo cp lib/libcudnn* /usr/local/cuda-13.0/lib64/
sudo chmod a+r /usr/local/cuda-13.0/include/cudnn*.h /usr/local/cuda-13.0/lib64/libcudnn*

# éªŒè¯cuDNN
cat /usr/local/cuda-13.0/include/cudnn_version.h | grep CUDNN_MAJOR -A 2
```

---

## NVLinké…ç½®ä¸æ£€æµ‹

**é‡è¦è¯´æ˜**ï¼šNVLinkæ˜¯ç¡¬ä»¶å±‚é¢çš„GPUäº’è”æŠ€æœ¯ï¼Œ**ä¸éœ€è¦å•ç‹¬å®‰è£…é©±åŠ¨æˆ–è½¯ä»¶**ã€‚NVIDIAé©±åŠ¨ä¼šè‡ªåŠ¨è¯†åˆ«å’Œå¯ç”¨NVLinkã€‚æœ¬èŠ‚ä¸»è¦ä»‹ç»å¦‚ä½•éªŒè¯å’Œä¼˜åŒ–NVLinkã€‚

### NVLinkç»„ä»¶è¯´æ˜

**ç¡¬ä»¶å±‚é¢ï¼ˆå®‰è£…æ—¶å·²é…ç½®ï¼‰**ï¼š
- NVLinkæ¡¥æ¥å¡ï¼šç‰©ç†è¿æ¥GPUçš„ç¡¬ä»¶
- H20 GPUï¼šå†…ç½®NVLinkæ§åˆ¶å™¨

**è½¯ä»¶å±‚é¢ï¼ˆé©±åŠ¨è‡ªåŠ¨æ”¯æŒï¼‰**ï¼š
- NVIDIAé©±åŠ¨ï¼šè‡ªåŠ¨è¯†åˆ«NVLinkæ‹“æ‰‘
- CUDAï¼šè‡ªåŠ¨ä½¿ç”¨NVLinkåŠ é€Ÿ

**éœ€è¦å®‰è£…çš„ä¼˜åŒ–åº“**ï¼š
- **NCCL**ï¼ˆNVIDIA Collective Communications Libraryï¼‰ï¼šä¼˜åŒ–å¤šGPUé€šä¿¡
- **NCCLæµ‹è¯•å·¥å…·**ï¼šéªŒè¯NVLinkæ€§èƒ½

### 1. NVLinkç¡¬ä»¶æ£€æŸ¥

```bash
# æ£€æŸ¥NVLinkæ‹“æ‰‘
nvidia-smi topo -m

# é¢„æœŸè¾“å‡ºç¤ºä¾‹ (8å¡å…¨äº’è”):
#         GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7
# GPU0     X      NV18    NV18    NV18    NV18    NV18    NV18    NV18
# GPU1    NV18     X      NV18    NV18    NV18    NV18    NV18    NV18
# GPU2    NV18    NV18     X      NV18    NV18    NV18    NV18    NV18
# ...

# å›¾ä¾‹:
#   X    = Self
#   SYS  = Connection traversing PCIe as well as the SMP interconnect
#   NODE = Connection traversing PCIe as well as the interconnect between NUMA nodes
#   PHB  = Connection traversing PCIe as well as a PCIe Host Bridge
#   PXB  = Connection traversing multiple PCIe bridges
#   PIX  = Connection traversing at most a single PCIe bridge
#   NV#  = Connection traversing a bonded set of # NVLinks

# æŸ¥çœ‹è¯¦ç»†NVLinkçŠ¶æ€
nvidia-smi nvlink --status

# æŸ¥çœ‹NVLinkè¿æ¥ä¿¡æ¯
nvidia-smi nvlink --capabilities
```

### 2. å®‰è£…NCCLï¼ˆç”¨äºä¼˜åŒ–å¤šGPUé€šä¿¡ï¼‰

NCCLæ˜¯NVIDIAæä¾›çš„é›†åˆé€šä¿¡åº“ï¼Œä¸“é—¨ä¼˜åŒ–å¤šGPUé—´çš„æ•°æ®ä¼ è¾“ï¼Œå……åˆ†åˆ©ç”¨NVLinkå¸¦å®½ã€‚

```bash
# å®‰è£…NCCLåº“ï¼ˆå¿…éœ€ï¼Œç”¨äºå¤šGPUé€šä¿¡ä¼˜åŒ–ï¼‰
sudo apt install -y libnccl2 libnccl-dev

# éªŒè¯NCCLå®‰è£…
dpkg -l | grep nccl
```

### 3. NVLinkæ€§èƒ½æµ‹è¯•

```bash
# ä¸‹è½½å¹¶ç¼–è¯‘NCCLæµ‹è¯•å·¥å…·
cd ~
git clone https://github.com/NVIDIA/nccl-tests.git
cd nccl-tests

# ç¼–è¯‘NCCLæµ‹è¯•
make MPI=1 MPI_HOME=/usr/lib/x86_64-linux-gnu/openmpi CUDA_HOME=/usr/local/cuda-13.0

# è¿è¡Œå¸¦å®½æµ‹è¯• (all_reduce)
./build/all_reduce_perf -b 8 -e 1G -f 2 -g 8

# é¢„æœŸè¾“å‡ºåº”æ˜¾ç¤ºé«˜å¸¦å®½åˆ©ç”¨ç‡ (é€šè¿‡NVLink)
# ä¾‹å¦‚: å¯¹äºNVLink 4.0, æœŸæœ›å¸¦å®½ > 400 GB/s (8å¡)
```

### 4. NVLinkç‚¹å¯¹ç‚¹é€šä¿¡æµ‹è¯•

```bash
# ä½¿ç”¨CUDAç¤ºä¾‹æµ‹è¯•P2P
cd /usr/local/cuda-13.0/samples/1_Utilities/p2pBandwidthLatencyTest
sudo make
./p2pBandwidthLatencyTest

# é¢„æœŸè¾“å‡ºä¼šæ˜¾ç¤ºGPUé—´çš„å¸¦å®½å’Œå»¶è¿ŸçŸ©é˜µ
# é€šè¿‡NVLinkè¿æ¥çš„GPUåº”æ˜¾ç¤ºé«˜å¸¦å®½ (ä¾‹å¦‚ > 200 GB/s)
```

### 5. é…ç½®NVLinkä¼˜åŒ–å‚æ•°ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ›å»ºNVLinké…ç½®è„šæœ¬
cat > ~/nvlink_config.sh << 'EOF'
#!/bin/bash
# NVLinkä¼˜åŒ–é…ç½®

# å¯ç”¨GPUDirect RDMA (å¦‚æœç¡¬ä»¶æ”¯æŒ)
echo 1 | sudo tee /sys/module/nvidia/drivers/pci\:nvidia/*/gdrdrv/power/control

# è®¾ç½®NCCLç¯å¢ƒå˜é‡
export NCCL_DEBUG=INFO
export NCCL_IB_DISABLE=0
export NCCL_NET_GDR_LEVEL=5
export NCCL_P2P_LEVEL=NVL  # å¼ºåˆ¶ä½¿ç”¨NVLink
export NCCL_NVLS_ENABLE=0  # å¦‚æœæœ‰é—®é¢˜å¯ç¦ç”¨NVLink Sharp

# éªŒè¯é…ç½®
echo "NVLinké…ç½®å®Œæˆ"
nvidia-smi nvlink --status
EOF

chmod +x ~/nvlink_config.sh
```

### 6. æŒç»­ç›‘æ§NVLink

```bash
# åˆ›å»ºNVLinkç›‘æ§è„šæœ¬
cat > ~/monitor_nvlink.sh << 'EOF'
#!/bin/bash
# NVLinkå®æ—¶ç›‘æ§

echo "NVLinkå®æ—¶ç›‘æ§ - æŒ‰Ctrl+Cé€€å‡º"
echo "================================"

while true; do
    clear
    echo "=== NVLinkçŠ¶æ€ ($(date '+%Y-%m-%d %H:%M:%S')) ==="
    nvidia-smi nvlink --status | grep -E "GPU|Link"

    echo -e "\n=== NVLinkæµé‡ (è¯»/å†™ MB/s) ==="
    nvidia-smi nvlink -g 0 -i 0

    sleep 2
done
EOF

chmod +x ~/monitor_nvlink.sh

# è¿è¡Œç›‘æ§
~/monitor_nvlink.sh
```

### 7. NVLinkæ•…éšœè¯Šæ–­

```bash
# æ£€æŸ¥NVLinké”™è¯¯
nvidia-smi nvlink -e

# æ£€æŸ¥æ˜¯å¦æœ‰é™é€Ÿè¿æ¥
nvidia-smi nvlink --status | grep -i "down\|error"

# é‡ç½®NVLinkè®¡æ•°å™¨
sudo nvidia-smi nvlink -r

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
dmesg | grep -i nvidia
journalctl -u nvidia-persistenced -f
```

---

## ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ä¼˜åŒ–

```bash
# è°ƒæ•´swapä½¿ç”¨å€¾å‘ (0-100, å€¼è¶Šå°è¶Šå€¾å‘ä½¿ç”¨ç‰©ç†å†…å­˜)
echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf

# è°ƒæ•´è„é¡µå›å†™å‚æ•°
echo "vm.dirty_ratio=15" | sudo tee -a /etc/sysctl.conf
echo "vm.dirty_background_ratio=5" | sudo tee -a /etc/sysctl.conf

# ç¦ç”¨é€æ˜å¤§é¡µ (å¯¹æŸäº›å·¥ä½œè´Ÿè½½æœ‰ç›Š)
echo "never" | sudo tee /sys/kernel/mm/transparent_hugepage/enabled

# åº”ç”¨é…ç½®
sudo sysctl -p
```

### 2. ç£ç›˜I/Oä¼˜åŒ–

```bash
# æŸ¥çœ‹ç£ç›˜è°ƒåº¦å™¨
cat /sys/block/nvme0n1/queue/scheduler

# å¯¹äºNVMe SSDï¼Œä½¿ç”¨noneæˆ–mq-deadline
echo "none" | sudo tee /sys/block/nvme0n1/queue/scheduler

# æ°¸ä¹…é…ç½® (ç¼–è¾‘/etc/udev/rules.d/60-scheduler.rules)
sudo tee /etc/udev/rules.d/60-scheduler.rules > /dev/null << 'EOF'
# NVMe SSDè°ƒåº¦å™¨è®¾ç½®
ACTION=="add|change", KERNEL=="nvme[0-9]n[0-9]", ATTR{queue/scheduler}="none"

# SATA SSDè°ƒåº¦å™¨è®¾ç½®
ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="0", ATTR{queue/scheduler}="mq-deadline"
EOF

# åº”ç”¨udevè§„åˆ™
sudo udevadm control --reload-rules
sudo udevadm trigger
```

### 3. ç½‘ç»œä¼˜åŒ–

```bash
# å¢åŠ ç½‘ç»œç¼“å†²åŒºå¤§å°
sudo tee -a /etc/sysctl.conf > /dev/null << 'EOF'
# ç½‘ç»œä¼˜åŒ–
net.core.rmem_max=134217728
net.core.wmem_max=134217728
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864
net.core.netdev_max_backlog=5000
net.ipv4.tcp_congestion_control=bbr
EOF

# åº”ç”¨é…ç½®
sudo sysctl -p
```

### 4. æ–‡ä»¶æè¿°ç¬¦é™åˆ¶

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
sudo tee -a /etc/security/limits.conf > /dev/null << 'EOF'
*    soft nofile 1048576
*    hard nofile 1048576
*    soft nproc  unlimited
*    hard nproc  unlimited
EOF

# ä¿®æ”¹systemdé™åˆ¶
sudo mkdir -p /etc/systemd/system.conf.d/
sudo tee /etc/systemd/system.conf.d/limits.conf > /dev/null << 'EOF'
[Manager]
DefaultLimitNOFILE=1048576
DefaultLimitNPROC=unlimited
EOF

# é‡å¯ä»¥åº”ç”¨
sudo reboot
```

---

## vLLMç¯å¢ƒéƒ¨ç½²

ç°åœ¨ç³»ç»Ÿå·²ç»å®Œå…¨é…ç½®å¥½ï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²vLLMäº†ã€‚

### å¿«é€Ÿéƒ¨ç½²

```bash
# å…‹éš†éƒ¨ç½²è„šæœ¬ (å‡è®¾ä½ å·²ç»æœ‰ä¹‹å‰åˆ›å»ºçš„è„šæœ¬)
cd ~
mkdir -p H20_vllm_deployment
cd H20_vllm_deployment

# è¿è¡Œç¯å¢ƒé…ç½®è„šæœ¬
./setup_environment.sh

# ä¸‹è½½æ¨¡å‹
./download_model.sh

# å¯åŠ¨æ¨ç†æœåŠ¡
./start_inference.sh
```

è¯¦ç»†æ­¥éª¤è¯·å‚è€ƒä¹‹å‰åˆ›å»ºçš„æ–‡æ¡£ã€‚

---

## å®Œæ•´æ€§éªŒè¯

### 1. ç³»ç»ŸéªŒè¯è„šæœ¬

åˆ›å»ºå®Œæ•´çš„ç³»ç»ŸéªŒè¯è„šæœ¬:

```bash
cat > ~/system_validation.sh << 'EOF'
#!/bin/bash
# H20æœåŠ¡å™¨å®Œæ•´æ€§éªŒè¯è„šæœ¬

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "=========================================="
echo "H20æœåŠ¡å™¨å®Œæ•´æ€§éªŒè¯"
echo "=========================================="

# 1. æ“ä½œç³»ç»Ÿæ£€æŸ¥
echo -e "\n${GREEN}[1/10] æ“ä½œç³»ç»Ÿæ£€æŸ¥${NC}"
echo "  å‘è¡Œç‰ˆ: $(lsb_release -d | cut -f2)"
echo "  å†…æ ¸ç‰ˆæœ¬: $(uname -r)"

# 2. CPUæ£€æŸ¥
echo -e "\n${GREEN}[2/10] CPUæ£€æŸ¥${NC}"
CPU_CORES=$(nproc)
echo "  CPUæ ¸å¿ƒæ•°: $CPU_CORES"
echo "  CPUè°ƒåº¦å™¨: $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || echo 'æœªé…ç½®')"
echo "  NUMAèŠ‚ç‚¹æ•°: $(numactl --hardware | grep available | awk '{print $2}')"

# 3. å†…å­˜æ£€æŸ¥
echo -e "\n${GREEN}[3/10] å†…å­˜æ£€æŸ¥${NC}"
MEM_TOTAL=$(free -h | grep Mem | awk '{print $2}')
echo "  æ€»å†…å­˜: $MEM_TOTAL"
echo "  Swap: $(free -h | grep Swap | awk '{print $2}')"

# 4. å­˜å‚¨æ£€æŸ¥
echo -e "\n${GREEN}[4/10] å­˜å‚¨æ£€æŸ¥${NC}"
df -h | grep -E "Filesystem|/$|/data"

# 5. NVIDIAé©±åŠ¨æ£€æŸ¥
echo -e "\n${GREEN}[5/10] NVIDIAé©±åŠ¨æ£€æŸ¥${NC}"
if command -v nvidia-smi &> /dev/null; then
    DRIVER_VERSION=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader | head -1)
    echo -e "  ${GREEN}âœ“ é©±åŠ¨ç‰ˆæœ¬: $DRIVER_VERSION${NC}"
else
    echo -e "  ${RED}âœ— NVIDIAé©±åŠ¨æœªå®‰è£…${NC}"
fi

# 6. GPUæ£€æŸ¥
echo -e "\n${GREEN}[6/10] GPUæ£€æŸ¥${NC}"
if command -v nvidia-smi &> /dev/null; then
    GPU_COUNT=$(nvidia-smi --query-gpu=name --format=csv,noheader | wc -l)
    echo "  GPUæ•°é‡: $GPU_COUNT"
    nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader
    if [ "$GPU_COUNT" -eq 8 ]; then
        echo -e "  ${GREEN}âœ“ GPUæ•°é‡æ­£ç¡®${NC}"
    else
        echo -e "  ${YELLOW}âš  é¢„æœŸ8å¼ GPUï¼Œå®é™…: $GPU_COUNT${NC}"
    fi
fi

# 7. CUDAæ£€æŸ¥
echo -e "\n${GREEN}[7/10] CUDAæ£€æŸ¥${NC}"
if command -v nvcc &> /dev/null; then
    CUDA_VERSION=$(nvcc --version | grep release | awk '{print $5}' | cut -d',' -f1)
    echo -e "  ${GREEN}âœ“ CUDAç‰ˆæœ¬: $CUDA_VERSION${NC}"
else
    echo -e "  ${YELLOW}âš  CUDAæœªå®‰è£…æˆ–æœªé…ç½®ç¯å¢ƒå˜é‡${NC}"
fi

# 8. NVLinkæ£€æŸ¥
echo -e "\n${GREEN}[8/10] NVLinkæ£€æŸ¥${NC}"
if command -v nvidia-smi &> /dev/null; then
    NVLINK_STATUS=$(nvidia-smi nvlink --status 2>/dev/null | grep -c "Active")
    if [ "$NVLINK_STATUS" -gt 0 ]; then
        echo -e "  ${GREEN}âœ“ NVLinkæ´»åŠ¨è¿æ¥æ•°: $NVLINK_STATUS${NC}"
    else
        echo -e "  ${YELLOW}âš  NVLinkçŠ¶æ€æœªçŸ¥æˆ–æœªè¿æ¥${NC}"
    fi
fi

# 9. Pythonç¯å¢ƒæ£€æŸ¥
echo -e "\n${GREEN}[9/10] Pythonç¯å¢ƒæ£€æŸ¥${NC}"
if [ -d "vllm-env" ]; then
    echo -e "  ${GREEN}âœ“ vLLMè™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º${NC}"
    source vllm-env/bin/activate 2>/dev/null
    if command -v python &> /dev/null; then
        echo "  Pythonç‰ˆæœ¬: $(python --version)"
    fi
    if python -c "import vllm" 2>/dev/null; then
        VLLM_VERSION=$(python -c "import vllm; print(vllm.__version__)" 2>/dev/null)
        echo -e "  ${GREEN}âœ“ vLLMå·²å®‰è£…: $VLLM_VERSION${NC}"
    else
        echo -e "  ${YELLOW}âš  vLLMæœªå®‰è£…${NC}"
    fi
    deactivate 2>/dev/null
else
    echo -e "  ${YELLOW}âš  vLLMè™šæ‹Ÿç¯å¢ƒæœªåˆ›å»º${NC}"
fi

# 10. ç½‘ç»œæ£€æŸ¥
echo -e "\n${GREEN}[10/10] ç½‘ç»œæ£€æŸ¥${NC}"
if ping -c 1 8.8.8.8 &> /dev/null; then
    echo -e "  ${GREEN}âœ“ ç½‘ç»œè¿æ¥æ­£å¸¸${NC}"
else
    echo -e "  ${RED}âœ— ç½‘ç»œè¿æ¥å¤±è´¥${NC}"
fi

echo -e "\n=========================================="
echo "éªŒè¯å®Œæˆï¼"
echo "=========================================="
EOF

chmod +x ~/system_validation.sh

# è¿è¡ŒéªŒè¯
~/system_validation.sh
```

### 2. GPUå‹åŠ›æµ‹è¯•

```bash
# å®‰è£…GPU burnæµ‹è¯•å·¥å…·
cd ~
git clone https://github.com/wilicc/gpu-burn.git
cd gpu-burn
make

# è¿è¡Œ10åˆ†é’Ÿå‹åŠ›æµ‹è¯• (æ‰€æœ‰GPU)
./gpu_burn 600

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§
watch -n 1 nvidia-smi
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œä¹‹å‰åˆ›å»ºçš„benchmarkè„šæœ¬
cd ~/H20_vllm_deployment
python benchmark.py --model-path /data/models/deepseek-v3
```

---

## æ•…éšœæ’æŸ¥æ¸…å•

### GPUæœªæ£€æµ‹åˆ°

```bash
# æ£€æŸ¥PCIeè®¾å¤‡
lspci | grep -i nvidia

# æ£€æŸ¥BIOSè®¾ç½®
# - ç¡®è®¤PCIeæ’æ§½å·²å¯ç”¨
# - ç¡®è®¤Above 4G Decodingå·²å¯ç”¨
# - ç¡®è®¤Resizable BARå·²å¯ç”¨ (å¯é€‰)

# æ£€æŸ¥ç‰©ç†è¿æ¥
# - ç¡®è®¤GPUä¾›ç”µçº¿å·²è¿æ¥
# - é‡æ–°æ’æ‹”GPUå¡
```

### NVLinkä¸å·¥ä½œ

```bash
# æ£€æŸ¥æ¡¥æ¥çº¿è¿æ¥
nvidia-smi topo -m

# å¦‚æœæ˜¾ç¤ºPHBæˆ–PIXè€Œä¸æ˜¯NV##:
# - æ£€æŸ¥NVLinkæ¡¥æ¥çº¿æ˜¯å¦æ­£ç¡®å®‰è£…
# - æ£€æŸ¥GPUå‹å·æ˜¯å¦æ”¯æŒNVLink
# - é‡å¯ç³»ç»Ÿ

# æŸ¥çœ‹NVLinké”™è¯¯
nvidia-smi nvlink -e
```

### é©±åŠ¨å®‰è£…å¤±è´¥

```bash
# å®Œå…¨å¸è½½æ—§é©±åŠ¨
sudo apt purge nvidia-* -y
sudo apt autoremove -y

# æ¸…ç†æ®‹ç•™
sudo rm -rf /usr/local/cuda*
sudo rm -rf /etc/modprobe.d/blacklist-nouveau.conf

# é‡æ–°å®‰è£…
sudo ubuntu-drivers autoinstall
sudo reboot
```

---

## é™„å½•: æ¨èçš„ç›‘æ§å’Œç®¡ç†å·¥å…·

### 1. å®‰è£…Grafana + Prometheus (å¯é€‰)

ç”¨äºé•¿æœŸç›‘æ§GPUå’Œç³»ç»Ÿæ€§èƒ½:

```bash
# å®‰è£…Prometheus
sudo apt install -y prometheus

# å®‰è£…NVIDIA DCGM Exporter
docker run -d --gpus all --rm -p 9400:9400 nvcr.io/nvidia/k8s/dcgm-exporter:latest

# å®‰è£…Grafana
sudo apt install -y grafana

# é…ç½®Grafanaç›‘æ§GPU
# è®¿é—® http://your-server:3000
```

### 2. å®‰è£…è¿œç¨‹ç®¡ç†å·¥å…·

```bash
# å®‰è£…Cockpit (Webç®¡ç†ç•Œé¢)
sudo apt install -y cockpit
sudo systemctl enable --now cockpit.socket

# è®¿é—® https://your-server:9090
```

---

## æ€»ç»“

è‡³æ­¤ï¼Œä½ å·²ç»å®Œæˆäº†ä»æ“ä½œç³»ç»Ÿå®‰è£…åˆ°vLLMéƒ¨ç½²çš„å…¨éƒ¨é…ç½®ï¼š

1. âœ… Ubuntu 22.04 LTSå®‰è£…å’ŒåŸºç¡€é…ç½®
2. âœ… å¤šæ ¸CPUä¼˜åŒ– (æ€§èƒ½æ¨¡å¼ã€NUMAã€äº²å’Œæ€§)
3. âœ… NVIDIAé©±åŠ¨å’ŒCUDA Toolkitå®‰è£…
4. âœ… NVLinké…ç½®å’Œæ€§èƒ½éªŒè¯
5. âœ… ç³»ç»Ÿæ€§èƒ½å…¨é¢ä¼˜åŒ–
6. âœ… vLLMæ¨ç†ç¯å¢ƒéƒ¨ç½²

**åç»­æ­¥éª¤:**
- ä½¿ç”¨ `./setup_environment.sh` é…ç½®vLLMç¯å¢ƒ
- ä½¿ç”¨ `./download_model.sh` ä¸‹è½½Deepseek V3æ¨¡å‹
- ä½¿ç”¨ `./start_inference.sh` å¯åŠ¨æ¨ç†æœåŠ¡
- ä½¿ç”¨ `~/system_validation.sh` å®šæœŸéªŒè¯ç³»ç»ŸçŠ¶æ€

**æ€§èƒ½ä¼˜åŒ–å»ºè®®:**
- å®šæœŸæ›´æ–°NVIDIAé©±åŠ¨å’ŒCUDA
- ç›‘æ§GPUæ¸©åº¦å’ŒåŠŸè€—
- æ ¹æ®å·¥ä½œè´Ÿè½½è°ƒæ•´CPUéš”ç¦»å’ŒNUMAç­–ç•¥
- ä½¿ç”¨NVLinkç›‘æ§å·¥å…·ç¡®ä¿é«˜é€Ÿäº’è”æ­£å¸¸å·¥ä½œ

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€
